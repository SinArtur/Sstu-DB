# Настройка ручной синхронизации расписания

## Что было сделано

1. **Добавлена кнопка для админов на странице расписания**
   - Кнопка "Обновить расписание" видна только администраторам
   - При нажатии запускается синхронизация расписания
   - Показывается прогресс и результат синхронизации

2. **Создан API endpoint для ручной синхронизации**
   - `/api/schedule/updates/trigger_sync_sync/` - синхронная синхронизация (только для админов)
   - `/api/schedule/updates/trigger_sync/` - асинхронная синхронизация через Celery (только для админов)

3. **Создан скрипт для автоматической синхронизации с вашего компьютера**
   - `schedule_sync_client.py` - Python скрипт для периодической синхронизации
   - Можно настроить автозапуск через Планировщик заданий Windows или NSSM

## Использование кнопки на сайте

1. Войдите на сайт как администратор
2. Перейдите на страницу "Расписание"
3. Нажмите кнопку "Обновить расписание" (зеленая кнопка справа вверху)
4. Дождитесь завершения синхронизации (может занять несколько минут)

## Настройка автоматической синхронизации с вашего компьютера

### Шаг 1: Установите зависимости

```bash
pip install -r requirements_sync_client.txt
```

### Шаг 2: Получите токен доступа

1. Войдите на сайт как администратор
2. Откройте консоль браузера (F12)
3. Перейдите на вкладку **Application** (Chrome) или **Storage** (Firefox)
4. Найдите **Local Storage** -> ваш домен
5. Найдите ключ `auth-storage` и откройте его
6. Скопируйте значение `accessToken`

### Шаг 3: Создайте файл .env

Скопируйте `schedule_sync_client.env.example` в `.env` и заполните:

```env
API_BASE_URL=https://your-server.com/api
API_TOKEN=your_access_token_here
SYNC_INTERVAL_HOURS=3
LOG_LEVEL=INFO
```

### Шаг 4: Запустите скрипт

**Однократный запуск:**
```bash
python schedule_sync_client.py --once
```

**Запуск с автоматическим расписанием:**
```bash
python schedule_sync_client.py
```

### Шаг 5: Настройте автозапуск (опционально)

См. подробные инструкции в `SCHEDULE_SYNC_CLIENT_README.md`

## Важные замечания

1. **Токен истекает** - JWT токены имеют срок действия. Если синхронизация перестала работать, обновите токен в `.env`

2. **Синхронизация может занять время** - Парсинг всех групп может занять 5-15 минут в зависимости от количества групп

3. **Не запускайте несколько синхронизаций одновременно** - API проверяет, не выполняется ли уже синхронизация

4. **Логи** - Все действия логируются в `logs/schedule_sync.log`

## Устранение проблем

### "Ошибка доступа: У вас нет прав администратора"
- Убедитесь, что используете токен администратора
- Проверьте, что токен не истек

### "Не удалось подключиться к API"
- Проверьте, что `API_BASE_URL` указан правильно
- Убедитесь, что сервер доступен с вашего компьютера

### "Синхронизация уже выполняется"
- Подождите завершения текущей синхронизации
- Или проверьте статус на сервере

