# Настройка синхронизации расписания на сервере

## Что уже сделано локально

✅ Создан файл `schedule_sync_client.env` с настройками  
✅ Установлены все зависимости Python  
✅ Созданы скрипты для запуска (`start_sync.bat`, `start_sync_once.bat`)  
✅ Скрипт синхронизации готов к работе  

## Что нужно сделать на сервере

### 1. Убедитесь, что API endpoint работает

Проверьте, что endpoint для синхронизации доступен:

```bash
# Проверьте, что endpoint существует
curl -X POST https://polikek.ru/api/schedule/updates/trigger_sync_sync/ \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json"
```

Если получаете 401 или 403, проверьте:
- Что пользователь имеет права администратора
- Что CSRF настройки правильные (уже настроено)

### 2. Проверьте, что база данных готова

```bash
cd ~/opt/Sstu-DB
docker compose -f docker-compose.prod.yml exec backend python manage.py shell -c "
from schedule.models import Institute, Group, Lesson
print(f'Институтов: {Institute.objects.count()}')
print(f'Групп: {Group.objects.count()}')
print(f'Занятий: {Lesson.objects.count()}')
"
```

### 3. Проверьте логи при синхронизации

После запуска синхронизации (через кнопку на сайте или через API), проверьте логи:

```bash
docker compose -f docker-compose.prod.yml logs backend --tail=100 | grep -i "schedule\|sync\|parser"
```

### 4. (Опционально) Настройте мониторинг синхронизации

Можно добавить проверку последнего обновления:

```bash
# Проверка последнего обновления
docker compose -f docker-compose.prod.yml exec backend python manage.py shell -c "
from schedule.models import ScheduleUpdate
last = ScheduleUpdate.objects.order_by('-started_at').first()
if last:
    print(f'Последнее обновление: {last.started_at}')
    print(f'Статус: {last.get_status_display()}')
    print(f'Групп обновлено: {last.groups_updated}')
    print(f'Занятий добавлено: {last.lessons_added}')
else:
    print('Обновлений еще не было')
"
```

## Что нужно сделать локально (на вашем компьютере)

### 1. Получите токен доступа

1. Войдите на сайт `https://polikek.ru` как администратор
2. Откройте консоль браузера (F12)
3. Перейдите на вкладку **Console**
4. Выполните команду:
   ```javascript
   JSON.parse(localStorage.getItem('auth-storage')).accessToken
   ```
5. Скопируйте полученный токен (длинная строка)

### 2. Обновите файл `schedule_sync_client.env`

Откройте файл `schedule_sync_client.env` в корне проекта и замените:
```
API_TOKEN=ВАШ_ТОКЕН_ЗДЕСЬ
```
на:
```
API_TOKEN=ваш_реальный_токен_из_браузера
```

### 3. Проверьте работу синхронизации

Запустите однократную синхронизацию для проверки:

```bash
# Вариант 1: Через батник
start_sync_once.bat

# Вариант 2: Через командную строку
python schedule_sync_client.py --once
```

Если все работает, вы увидите сообщение об успешной синхронизации.

### 4. Настройте автозапуск (опционально)

**Вариант A: Через Планировщик заданий Windows**

1. Откройте **Планировщик заданий** (Task Scheduler)
2. Создайте новую задачу:
   - **Имя:** "Синхронизация расписания СГТУ"
   - **Триггер:** При входе в систему
   - **Действие:** Запустить программу
     - **Программа:** `python.exe` (полный путь, например: `C:\Python312\python.exe`)
     - **Аргументы:** `"C:\Users\sinan\SSTUDB\schedule_sync_client.py"`
     - **Рабочая папка:** `C:\Users\sinan\SSTUDB`
   - **Условия:** Снимите галочку "Останавливать задачу, если компьютер переходит в режим ожидания"
   - **Параметры:** Выберите "Запускать задачу немедленно, если пропущен запланированный запуск"

**Вариант B: Через автозагрузку Windows**

1. Нажмите `Win + R`
2. Введите `shell:startup`
3. Скопируйте ярлык файла `start_sync.bat` в открывшуюся папку

## Важные замечания

1. **Токен истекает** - JWT токены имеют срок действия (обычно 24 часа или больше). Если синхронизация перестала работать, обновите токен в `schedule_sync_client.env`

2. **Синхронизация может занять время** - Парсинг всех групп может занять 5-15 минут в зависимости от количества групп

3. **Не запускайте несколько синхронизаций одновременно** - API проверяет, не выполняется ли уже синхронизация

4. **Логи** - Все действия логируются в `logs/schedule_sync.log` на вашем компьютере

5. **Безопасность** - Файл `schedule_sync_client.env` содержит секретный токен. Не публикуйте его в Git! (он уже в .gitignore)

## Устранение проблем

### "Ошибка доступа: У вас нет прав администратора"
- Убедитесь, что используете токен администратора
- Проверьте, что токен не истек (войдите на сайт заново и получите новый токен)

### "Не удалось подключиться к API"
- Проверьте, что `API_BASE_URL` указан правильно: `https://polikek.ru/api`
- Убедитесь, что сервер доступен с вашего компьютера
- Проверьте файрвол и сетевые настройки

### "Синхронизация уже выполняется"
- Подождите завершения текущей синхронизации
- Или проверьте статус на сервере через Django admin

### Скрипт не запускается автоматически
- Проверьте логи в `logs/schedule_sync.log`
- Убедитесь, что Python установлен и доступен из командной строки
- Проверьте права доступа к файлам

