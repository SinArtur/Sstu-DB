#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –¥–ª—è polikek.ru

set -e

DOMAIN="polikek.ru"
EMAIL="${1:-admin@polikek.ru}"  # Email –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π Let's Encrypt

echo "üîí –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –¥–ª—è $DOMAIN..."

# 1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ certbot (–µ—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
if ! command -v certbot &> /dev/null; then
    echo "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ certbot..."
    sudo apt-get update
    sudo apt-get install -y certbot
fi

# 2. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ nginx –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤—Ä–µ–º–µ–Ω–Ω–æ (certbot –Ω—É–∂–µ–Ω –ø–æ—Ä—Ç 80)
echo "–û—Å—Ç–∞–Ω–æ–≤–∫–∞ nginx –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
cd ~/opt/Sstu-DB
docker compose -f docker-compose.prod.yml stop nginx

# 3. –ü–æ–ª—É—á–∏—Ç–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
echo "–ü–æ–ª—É—á–µ–Ω–∏–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞..."
sudo certbot certonly --standalone \
    -d $DOMAIN \
    -d www.$DOMAIN \
    --email $EMAIL \
    --agree-tos \
    --non-interactive \
    --preferred-challenges http

# 4. –°–æ–∑–¥–∞–π—Ç–µ –ø–∞–ø–∫—É –¥–ª—è SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ (–µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
mkdir -p nginx/ssl

# 5. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã
echo "–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤..."
sudo cp /etc/letsencrypt/live/$DOMAIN/fullchain.pem nginx/ssl/
sudo cp /etc/letsencrypt/live/$DOMAIN/privkey.pem nginx/ssl/
sudo chown $USER:$USER nginx/ssl/*

# 6. –ó–∞–ø—É—Å—Ç–∏—Ç–µ nginx –æ–±—Ä–∞—Ç–Ω–æ
echo "–ó–∞–ø—É—Å–∫ nginx –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
docker compose -f docker-compose.prod.yml up -d nginx

echo "‚úÖ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω!"
echo ""
echo "–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo "1. –û–±–Ω–æ–≤–∏—Ç–µ nginx/nginx.prod.conf - —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ HTTPS –±–ª–æ–∫"
echo "2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ nginx: docker compose -f docker-compose.prod.yml restart nginx"
echo "3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ (cron job)"

